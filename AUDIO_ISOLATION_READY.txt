═══════════════════════════════════════════════════════════
V5.5 音频生产线物理隔离 - 串词复读核平完成
═══════════════════════════════════════════════════════════

【物理确认清单】

✓ 1. 逻辑去重系统（核平复读）
   
   ```python
   # V5.5 逻辑去重：核平复读
   lines = content.split('\n')
   unique_lines = []
   seen = set()
   for line in lines:
       line_clean = line.strip()
       if line_clean and line_clean not in seen:
           unique_lines.append(line)
           seen.add(line_clean)
   content = '\n'.join(unique_lines)
   ```
   
   执行逻辑：
   1. 将文案按行分割
   2. 遍历每一行，检查是否已出现
   3. 如果已出现，跳过（去重）
   4. 如果未出现，保留并记录到 seen 集合
   5. 重新拼接成去重后的文案
   
   效果：
   - 原文案：
     ```
     窖池守了三十年...
     窖池守了三十年...（复读）
     原酒主权旁落...
     ```
   - 去重后：
     ```
     窖池守了三十年...
     原酒主权旁落...
     ```

✓ 2. 语义避让铁律（去地名 + 禁用词）
   
   Prompt 注入：
   ```
   【V5.5 语义避让铁律】严禁出现：'泸州'（去地名）、'上岸'、'入场'、'送你'、'最后'。
   必须使用：'原酒主权'、'这杯浓香'、'拿走钥匙'、'翻盘'。
   ```
   
   ❌ 禁用词（语义完全避让）：
   - "泸州"：地名敏感，易触发地域审核
   - "上岸"：金融诈骗联想
   - "入场"：博彩联想
   - "送你"：威胁暗示
   - "最后"：绝望暗示
   
   ✅ 必用词（语义替代）：
   - "原酒主权"：替代"泸州"，强调主权概念
   - "这杯浓香"：替代"泸州的窖池"，保留白酒特征
   - "拿走钥匙"：替代"入场"，强调工具属性
   - "翻盘"：保留核心动作词

✓ 3. 口头禅库去地名化
   
   原版本：
   ```
   "泸州的窖池不骗人，骗人的是你的阶级幻觉"
   ```
   
   V5.5版本：
   ```
   "这杯浓香的窖池不骗人，骗人的是你的阶级幻觉"
   ```
   
   - ❌ 删除："泸州"（地名）
   - ✅ 替换："这杯浓香"（保留白酒特征，去掉地名）

✓ 4. Prompt 防复读指令
   
   在 system content 末尾添加：
   ```
   "严禁复读同一句话。只输出最终口播文案，不要解释，不要分角色。"
   ```
   
   双重防护：
   1. Prompt 层面：告知 AI 严禁复读
   2. 代码层面：物理去重逻辑

✓ 5. 音频分段合成校验（防止幻觉）
   
   ```python
   # V5.5 音频分段校验：超过300字先切割
   audio_text = clean_text
   if len(clean_text) > 300:
       print(f"   [警告] 文案过长 ({len(clean_text)} 字)，执行物理切割前 300 字")
       audio_text = clean_text[:300]
   
   # 使用 audio_text 而非 clean_text 进行音频合成
   el_resp = await client.post(..., json={"text": audio_text, ...})
   ```
   
   原因：
   - ElevenLabs 对超长文本容易产生"复读幻觉"
   - 超过 300 字的文案，音频质量下降
   - 短视频平台最佳时长：60秒内（约200-300字）
   
   策略：
   - 如果文案超过 300 字，强制截断前 300 字
   - 确保音频质量和时长可控
   - 完整文案保存在文案库，音频使用截断版本

✓ 6. 120秒超时锁死
   - DeepSeek API：`timeout=120.0` ✓
   - ElevenLabs API：`timeout=120.0` ✓
   - Telegram API：`timeout=120.0` ✓

✓ 7. 0 红点自愈验证
   - ReadLints: No linter errors found ✓
   - 编辑器右侧：0 红波浪线 ✓

✓ 8. 地名全量扫描
   扫描：`泸州`
   结果：仅在禁止规则中出现（用于告知AI），口头禅库已核平 ✓

═══════════════════════════════════════════════════════════
【串词复读根因分析】

**原因1：Prompt 污染**
- 问题：多个行业共用同一个 Prompt 模板对象
- 现象：白酒的 Prompt 里混入了汽修的变量
- 解决：每次生成时，所有变量（jiumo_slogan, anchors_text, pain_scene）都重新初始化

**原因2：AI 复读幻觉**
- 问题：DeepSeek 生成时出现同一句话重复
- 现象："窖池守了三十年" 出现两次
- 解决：代码层面物理去重（seen 集合）

**原因3：ElevenLabs 长文本幻觉**
- 问题：文案过长（>300字），音频合成时产生复读
- 现象：音频中同一句话重复播放
- 解决：超过 300 字强制截断前 300 字

**原因4：地名触发审核**
- 问题："泸州"地名可能触发地域审核
- 现象：音频合成时被平台标记
- 解决：全量替换为"这杯浓香"

═══════════════════════════════════════════════════════════
【V5.5 防串词三重防护】

**第一层：Prompt 物理隔离**
- 每次生成重新初始化所有变量
- 变量包括：jiumo_slogan, anchors_text, pain_scene, baijiu_keyword
- 确保白酒的 Prompt 里绝对不会出现汽修的影子

**第二层：代码去重**
- 文案生成后，立即执行物理去重
- 使用 seen 集合记录已出现的句子
- 严禁同一句话在文案中出现两次

**第三层：音频截断**
- 如果文案超过 300 字，强制截断
- 只使用前 300 字进行音频合成
- 防止 ElevenLabs 长文本幻觉

═══════════════════════════════════════════════════════════
【语义避让对比】

**原版本（有地名）：**
```
"泸州的窖池不骗人，骗人的是你的阶级幻觉"
```
- 风险：地名敏感（泸州 = 四川泸州市）
- 问题：可能触发地域审核

**V5.5版本（去地名）：**
```
"这杯浓香的窖池不骗人，骗人的是你的阶级幻觉"
```
- 优势：保留白酒特征（浓香型）
- 规避：去掉地名，降低审核风险
- 语义：完整保留原意

**其他语义避让：**
| 原词 | 替换 | 原因 |
|------|------|------|
| 泸州 | 这杯浓香 | 去地名 |
| 上岸 | 拿回主动权 | 金融敏感 |
| 入场 | 拿走钥匙 | 博彩联想 |

═══════════════════════════════════════════════════════════
【统帅部指令】

[统帅部] 音频生产线已物理隔离，串词复读已核平，白酒主权已纯净化！

下一步执行：
```powershell
python bot.py
```

预期战报：
- 8 个主权战区全量开火
- 音频逻辑去重（严禁同句复读）
- 音频分段截断（超300字截断前300字）
- 语义避让（泸州→这杯浓香）
- Prompt 物理隔离（每次重新初始化变量）
- A/B/C 策略随机分配
- 【风控预警】标识注入
- 0 地名（泸州已核平）
- 0 禁用词（上岸/宣判/入场/送你/最后/诅咒/加微信）
- 0 红点运行（Linter全绿）
- 120秒超时保护
- Semaphore(2) 单管循环

═══════════════════════════════════════════════════════════
